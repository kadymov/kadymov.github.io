<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Disco Dialogue Engine (Mobile)</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sidebar-bg: #2b2b2b;
            --text-color: #dcdcdc;
            --accent-orange: #d66935;
            --accent-red: #e04f4f;
            --accent-green: #5faf5f;
            --skill-blue: #6fa3d2;
            --skill-purple: #9b72aa;
            --skill-red: #c45a5a;
            --skill-yellow: #d4b648;
            --option-bg: #363636;
            --option-hover: #454545;
            --font-main: 'Georgia', serif;
            --font-ui: 'Arial', sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            height: 100dvh; /* Dynamic viewport height for mobile */
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* --- Mobile Overlay for Sidebar --- */
        #sidebar-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 150;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #sidebar-overlay.visible {
            display: block;
            opacity: 1;
        }

        /* --- Sidebar (Stats) --- */
        #sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            padding: 20px;
            border-right: 2px solid #000;
            display: flex;
            flex-direction: column;
            font-family: var(--font-ui);
            z-index: 200;
            transition: transform 0.3s ease-in-out;
        }

        .stat-block {
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .stat-title {
            font-weight: bold;
            text-transform: uppercase;
            color: #888;
            font-size: 0.8em;
            margin-bottom: 10px;
        }

        .skill-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .health-bar {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        .hp-pip {
            width: 15px;
            height: 8px;
            background-color: #444;
        }
        .hp-pip.active {
            background-color: var(--accent-orange);
        }

        /* Close button for mobile sidebar */
        .close-sidebar-btn {
            display: none;
            background: none;
            border: 1px solid #666;
            color: #fff;
            padding: 5px 10px;
            margin-bottom: 15px;
            cursor: pointer;
            text-transform: uppercase;
            align-self: flex-end;
        }

        /* --- Main Game Area --- */
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            margin: 0 auto;
            height: 100%;
            position: relative;
        }

        /* Mobile Header Button */
        #mobile-menu-btn {
            display: none; /* Hidden on desktop */
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 50;
            background: var(--sidebar-bg);
            border: 1px solid var(--accent-orange);
            color: var(--accent-orange);
            padding: 8px 12px;
            font-family: var(--font-ui);
            font-weight: bold;
            font-size: 0.8em;
            text-transform: uppercase;
            cursor: pointer;
        }

        #history-log {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            padding-top: 60px; /* Space for mobile button if needed */
            padding-bottom: 20px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .dialogue-entry {
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease;
        }

        .speaker-label {
            font-family: var(--font-ui);
            font-weight: bold;
            font-size: 0.85em;
            letter-spacing: 1px;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .speaker-YOU { color: var(--accent-orange); }
        .speaker-REPTILIAN { color: #7a8f7a; }
        .speaker-LIMBIC { color: #b57b8e; }
        .speaker-SYSTEM { color: #888; font-style: italic; }

        .dialogue-text {
            font-size: 1.05em;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        /* --- Options Area --- */
        #options-area {
            padding: 15px 20px;
            background: linear-gradient(to top, var(--bg-color) 90%, transparent);
            border-top: 1px solid #333;
            max-height: 45%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .option-btn {
            display: block;
            width: 100%;
            text-align: left;
            background-color: var(--option-bg);
            color: var(--text-color);
            border: 1px solid #444;
            padding: 14px 15px; /* Larger touch target */
            margin-bottom: 10px;
            cursor: pointer;
            font-family: var(--font-ui);
            font-size: 0.95em;
            transition: all 0.2s;
            position: relative;
            line-height: 1.3;
        }

        .option-btn:active {
            background-color: #555;
            transform: scale(0.98);
        }

        .option-btn:hover {
            border-color: #777;
        }

        @media (min-width: 769px) {
            .option-btn:hover {
                background-color: var(--option-hover);
                transform: translateX(5px);
            }
        }

        /* Skill Checks tags */
        .check-tag {
            display: inline-block;
            font-weight: bold;
            margin-right: 6px;
            padding: 2px 5px;
            border-radius: 3px;
            color: #111;
            font-size: 0.75em;
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        
        .check-logic { background-color: var(--skill-blue); }
        .check-physique { background-color: var(--skill-red); }
        .check-psyche { background-color: var(--skill-purple); }

        /* --- Dice Overlay --- */
        #dice-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 300;
            flex-direction: column;
            padding: 20px;
        }

        .dice-result-box {
            background: #222;
            border: 2px solid var(--text-color);
            padding: 30px;
            text-align: center;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .dice-nums {
            font-size: 2.5em;
            font-weight: bold;
            margin: 15px 0;
            font-family: var(--font-ui);
        }
        
        .check-status {
            font-size: 1.4em;
            text-transform: uppercase;
            font-weight: bold;
            margin-top: 10px;
        }
        .status-success { color: var(--accent-green); }
        .status-fail { color: var(--accent-red); }

        /* --- RESPONSIVE MEDIA QUERIES --- */
        @media (max-width: 768px) {
            /* Layout shifts to Mobile */
            
            /* Sidebar becomes Off-Canvas Drawer */
            #sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                transform: translateX(-100%); /* Hidden by default */
                box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            }

            #sidebar.open {
                transform: translateX(0);
            }

            .close-sidebar-btn {
                display: block;
            }

            /* Show Mobile Menu Button */
            #mobile-menu-btn {
                display: block;
            }

            /* Adjust spacing */
            #history-log {
                padding: 20px;
                padding-top: 60px; /* Ensure text doesn't go under the button */
            }

            .dialogue-text {
                font-size: 1em;
            }

            .dice-nums {
                font-size: 2em;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <!-- Mobile Overlay Backgdound -->
    <div id="sidebar-overlay"></div>

    <!-- Sidebar -->
    <div id="sidebar">
        <button class="close-sidebar-btn" id="close-menu-btn">✕ Закрыть</button>
        
        <div class="stat-block">
            <div class="stat-title">Здоровье</div>
            <div class="health-bar" id="hp-container"></div>
        </div>
        <div class="stat-block">
            <div class="stat-title">Мораль</div>
            <div class="health-bar" id="mp-container"></div>
        </div>
        <div class="stat-block">
            <div class="stat-title">Навыки (INT)</div>
            <div class="skill-row"><span>Logic</span> <span id="stat-logic">0</span></div>
            <div class="skill-row"><span>Rhetoric</span> <span id="stat-rhetoric">0</span></div>
        </div>
        <div class="stat-block">
            <div class="stat-title">Навыки (PHYS)</div>
            <div class="skill-row"><span>Endurance</span> <span id="stat-endurance">0</span></div>
            <div class="skill-row"><span>Phys. Instrument</span> <span id="stat-physical_instrument">0</span></div>
        </div>
        <div class="stat-block">
            <div class="stat-title">Навыки (PSY)</div>
            <div class="skill-row"><span>Inland Empire</span> <span id="stat-inland_empire">0</span></div>
            <div class="skill-row"><span>Empathy</span> <span id="stat-empathy">0</span></div>
        </div>
    </div>

    <!-- Game Area -->
    <div id="game-container">
        <button id="mobile-menu-btn">CHAR SHEET</button>

        <div id="history-log">
            <!-- Dialogue history goes here -->
        </div>
        <div id="options-area">
            <!-- Buttons go here -->
        </div>
    </div>

    <!-- Dice Overlay -->
    <div id="dice-overlay">
        <div class="dice-result-box">
            <div id="dice-skill-name" style="color: #888; text-transform: uppercase; font-size: 0.9em;">Logic</div>
            <div class="dice-nums">
                <span id="dice-val-1">?</span> + <span id="dice-val-2">?</span> + <span id="dice-bonus">0</span>
            </div>
            <div style="font-size: 0.8em; color: #666;">VS TARGET: <span id="dice-target">10</span></div>
            <div class="dice-nums" style="border-top: 1px solid #444; margin-top: 10px; padding-top: 10px;">
                = <span id="dice-total">0</span>
            </div>
            <div id="dice-status" class="check-status">ROLLING...</div>
            <button id="dice-continue-btn" class="option-btn" style="margin-top: 20px; display:none; text-align:center;">Продолжить</button>
        </div>
    </div>

<script>
/* =========================================
   1. DATA & CONFIGURATION (SAME AS BEFORE)
   ========================================= */

const storyData = {
    "meta": {
        "title": "Реквием по потерянному носку",
        "author": "Detective Costeau"
    },
    "nodes": {
        "start": {
            "id": "start",
            "speaker": "NARRATOR",
            "text": "Ночь. Дождь барабанит по крыше прачечной «Последний Шанс», как пальцы нервного джазового пианиста. Внутри пахнет хлоркой, дешевым лимонным ароматизатором и чьим-то одиночеством.\n\nТы стоишь перед Стиральной Машиной №4. В ее мутном стеклянном глазу, в пене и кипятке, вращается ОНА. Твоя Счастливая Рубашка. Та самая, с психоделическими огурцами.",
            "options": [
                { "text": "Тяжело вздохнуть и оценить ситуацию.", "next": "assess_situation" },
                { "text": "[INLAND EMPIRE] Прижаться лбом к стеклу. Почувствовать её боль.", "next": "commune_start" }
            ]
        },
        "assess_situation": {
            "id": "assess_situation",
            "speaker": "LOGIC",
            "text": "Цикл стирки закончился 40 минут назад. Индикатор «Door Lock» горит зловещим красным светом. Барабан неподвижен. Твоя рубашка находится в заложниках у механизма, произведенного несуществующей больше страной.",
            "options": [
                { "text": "Подергать ручку.", "next": "pull_handle" },
                { "text": "Осмотреться вокруг в поисках помощи.", "next": "room_hub" }
            ]
        },
        "pull_handle": {
            "id": "pull_handle",
            "speaker": "PHYSICAL INSTRUMENT",
            "text": "Заперто намертво. Эта ручка из дешевого пластика смеется над твоей мускулатурой. Если дернешь сильнее без подготовки — просто оторвешь её к чертям, и рубашка останется там до скончания веков.",
            "options": [
                { "text": "Нужно найти другой способ.", "next": "room_hub" }
            ]
        },
        "commune_start": {
            "id": "commune_start",
            "speaker": "INLAND EMPIRE",
            "text": "Стекло теплое и вибрирует. Ты слышишь гул. Это не просто мотор. Это утроба зверя. Машина №4 видела грязное белье этого города. Она знает секреты пятен крови, дешевого вина и предательства. Она не хочет отдавать рубашку. Рубашка слишком яркая для этого серого мира.",
            "options": [
                { "text": "«Отдай её. Она мне нужна».", "next": "machine_refusal" },
                { "text": "Отстраниться. Это становится слишком странным.", "next": "assess_situation" }
            ]
        },
        "machine_refusal": {
            "id": "machine_refusal",
            "speaker": "THE MACHINE",
            "text": "ГЛУХОЙ МЕТАЛЛИЧЕСКИЙ ЩЕЛЧОК. \n\nЗвучит как «НЕТ» на языке гидравлики.",
            "options": [
                { "text": "Ладно. Будем играть по-плохому.", "next": "room_hub" }
            ]
        },
        
        /* --- HUB ROOM --- */
        "room_hub": {
            "id": "room_hub",
            "speaker": "SCENE",
            "text": "Прачечная пуста. Только гул трансформатора и мигающая лампа дневного света. \n\nСлева стоит торговый автомат с едой. \nВ углу на стопке старых газет сидит невероятно толстый Кот. \nПрямо перед тобой — Машина №4.",
            "options": [
                { "text": "Подойти к Коту.", "next": "cat_approach" },
                { "text": "Изучить торговый автомат.", "next": "vending_machine" },
                { "text": "Вернуться к Машине №4 (Попробовать открыть).", "next": "machine_interaction" },
                { "text": "[LOGIC] Порыться в карманах. Может, там есть инструкция?", "next": "pockets_search", "condition": { "type": "stat", "key": "logic", "val": 3, "op": ">=" } }
            ]
        },

        /* --- CAT BRANCH --- */
        "cat_approach": {
            "id": "cat_approach",
            "speaker": "EMPATHY",
            "text": "Кот смотрит на тебя с презрением, доступным только существам, которые спят по 18 часов в сутки. У него нет одного уха, а на ошейнике написано «Комиссар».",
            "options": [
                { 
                    "text": "[EMPATHY] Попробовать наладить дипломатический контакт (Погладить).", 
                    "type": "check",
                    "check": { "skill": "empathy", "difficulty": 10, "success": "cat_success", "failure": "cat_fail" }
                },
                { "text": "[PHYSICAL INSTRUMENT] «Эй, животное, брысь!»", "next": "cat_aggro" },
                { "text": "Оставить кота в покое.", "next": "room_hub" }
            ]
        },
        "cat_success": {
            "id": "cat_success",
            "speaker": "COMMISSAR THE CAT",
            "text": "Кот издает звук, похожий на работающий дизельный двигатель. Он бодает твою руку головой. Из-под его лапы выкатывается блестящий предмет. Это шпилька для волос. Гнутая, но прочная.",
            "effects": [
                { "key": "morale", "val": 1 },
                { "key": "has_pin", "val": true }
            ],
            "options": [
                { "text": "«Спасибо, Комиссар». Взять шпильку.", "next": "room_hub" }
            ]
        },
        "cat_fail": {
            "id": "cat_fail",
            "speaker": "PAIN THRESHOLD",
            "text": "Молниеносный удар когтями! Твоя рука покрывается красными полосами. Кот шипит, как пробитый паровой котел.",
            "effects": [{ "key": "health", "val": -1 }],
            "options": [
                { "text": "Ай! Отступить!", "next": "room_hub" }
            ]
        },
        "cat_aggro": {
            "id": "cat_aggro",
            "speaker": "DRAMA",
            "text": "Кот медленно моргает. Ты чувствуешь себя идиотом, кричащим на кота в пустой прачечной в 3 часа ночи.",
            "effects": [{ "key": "morale", "val": -1 }],
            "options": [{ "text": "Уйти.", "next": "room_hub" }]
        },

        /* --- VENDING MACHINE BRANCH --- */
        "vending_machine": {
            "id": "vending_machine",
            "speaker": "ELECTROCHEMISTRY",
            "text": "Автомат гудит. Внутри: чипсы со вкусом уксуса, шоколад «Sartre» (99% какао, 1% пустоты) и банка энергетика «Blue Medic». Тебе нужно это топливо.",
            "options": [
                { 
                    "text": "Купить «Blue Medic» (Восстановить здоровье).", 
                    "condition": { "type": "stat", "key": "has_drink", "val": true, "op": "!=" }, /* Простая заглушка проверки флага, если бы движок поддерживал != */
                    "next": "buy_drink"
                },
                { 
                    "text": "[PHYSICAL INSTRUMENT] Ударить автомат, чтобы выпала монетка.", 
                    "type": "check",
                    "check": { "skill": "physical_instrument", "difficulty": 11, "success": "vending_kick_win", "failure": "vending_kick_fail" }
                },
                { "text": "Назад.", "next": "room_hub" }
            ]
        },
        "buy_drink": {
            "id": "buy_drink",
            "speaker": "ITEM OBTAINED",
            "text": "Ты скармливаешь автомату мелочь. Банка падает с грохотом, будящим мертвых. Ты выпиваешь приторную синюю жижу. Сердце начинает биться в ритме техно.",
            "effects": [
                { "key": "health", "val": 2 },
                { "key": "has_drink", "val": true } /* Флаг, что выпили */
            ],
            "options": [{ "text": "Я готов свернуть горы.", "next": "room_hub" }]
        },
        "vending_kick_win": {
            "id": "vending_kick_win",
            "speaker": "SAVOIR FAIRE",
            "text": "Удар в нужную точку! Из лотка возврата монет выпадает тяжелая монета в 2 реала. Удача на твоей стороне.",
            "effects": [{ "key": "morale", "val": 1 }, { "key": "has_coin", "val": true }],
            "options": [{ "text": "Взять монету.", "next": "room_hub" }]
        },
        "vending_kick_fail": {
            "id": "vending_kick_fail",
            "speaker": "LIMBIC SYSTEM",
            "text": "Ты бьешь автомат. Автомат стоит непоколебимо, как монумент капитализму. Твой палец опухает.",
            "effects": [{ "key": "health", "val": -1 }],
            "options": [{ "text": "Проклятье...", "next": "room_hub" }]
        },

        /* --- POCKETS SEARCH --- */
        "pockets_search": {
            "id": "pockets_search",
            "speaker": "LOGIC",
            "text": "В левом кармане — чек за виски. В правом — скомканная бумажка. Это чек из этой прачечной! На обороте кто-то (возможно, ты вчерашний) нацарапал код: «Удар, Удар, Пауза, Пинок».",
            "effects": [{ "key": "know_code", "val": true }],
            "options": [{ "text": "Запомнить это.", "next": "room_hub" }]
        },

        /* --- MAIN MACHINE INTERACTION --- */
        "machine_interaction": {
            "id": "machine_interaction",
            "speaker": "THE MACHINE",
            "text": "Ты снова перед врагом. №4 смотрит на тебя. Рубашка внутри кажется такой близкой, но такой далекой, как воспоминание о первой любви.",
            "options": [
                {
                    "text": "[PHYSICAL INSTRUMENT] «ПРОТОКОЛ: ГРУБАЯ СИЛА». Выбить дверь (Сложн: 12).",
                    "type": "check",
                    "check": { "skill": "physical_instrument", "difficulty": 12, "success": "force_open_success", "failure": "force_open_fail" }
                },
                {
                    "text": "[LOGIC] Использовать шпильку, чтобы взломать замок.",
                    "condition": { "type": "flag", "key": "has_pin", "val": true, "op": "==" }, /* Движок в примере был прост, представим, что он умеет проверять флаги или заменим на стат */
                    "next": "pin_attempt" 
                },
                {
                    "text": "[INTERFACING] Ввести секретный код ударов.",
                    "condition": { "type": "flag", "key": "know_code", "val": true, "op": "==" }, /* Опция видна только если нашли код */
                    "next": "code_attempt"
                },
                {
                    "text": "[INLAND EMPIRE] Провести экзорцизм машины (Сложн: 10).",
                    "type": "check",
                    "check": { "skill": "inland_empire", "difficulty": 10, "success": "exo_success", "failure": "exo_fail" }
                },
                { "text": "Назад.", "next": "room_hub" }
            ]
        },

        /* --- RESOLUTIONS --- */
        
        /* 1. Force */
        "force_open_success": {
            "id": "force_open_success",
            "speaker": "PHYSICAL INSTRUMENT",
            "text": "КРАК! Ты наносишь удар ногой точно в крепление. Пластик разлетается шрапнелью. Дверца распахивается, и мокрая, горячая куча белья вываливается тебе на ботинки. Победа человека над машиной.",
            "effects": [{ "key": "morale", "val": 2 }],
            "options": [{ "text": "Схватить рубашку!", "next": "victory_scene" }]
        },
        "force_open_fail": {
            "id": "force_open_fail",
            "speaker": "PAIN THRESHOLD",
            "text": "Ты бьешь со всей дури. Металл не поддается. Твое колено издает хруст, который слышен даже на улице. Ты сползаешь по машине вниз.",
            "effects": [{ "key": "health", "val": -2 }, { "key": "morale", "val": -1 }],
            "options": [
                { "text": "Лежать в позе эмбриона.", "next": "game_over_injury" },
                { "text": "Попробовать встать...", "next": "room_hub" }
            ]
        },

        /* 2. Pin Hack (Logic check needed usually, but simplified here as distinct node) */
        "pin_attempt": {
            "id": "pin_attempt",
            "speaker": "LOGIC",
            "text": "Ты вставляешь шпильку, полученную от кота, в щель замка. Легкое движение, поворот на 45 градусов...",
            "options": [
                {
                    "text": "[LOGIC] Нащупать механизм (Сложн: 8).",
                    "type": "check",
                    "check": { "skill": "logic", "difficulty": 8, "success": "pin_win", "failure": "pin_fail" }
                }
            ]
        },
        "pin_win": {
            "id": "pin_win",
            "speaker": "SAVOIR FAIRE",
            "text": "Щелк. Элегантно. Тихо. Дверь мягко открывается, выпуская облако пара.",
            "options": [{ "text": "Вуаля.", "next": "victory_scene" }]
        },
        "pin_fail": {
            "id": "pin_fail",
            "speaker": "HAND/EYE COORDINATION",
            "text": "Шпилька ломается внутри замка. Теперь он забит металлом. Молодец, медвежатник.",
            "effects": [{ "key": "morale", "val": -1 }],
            "options": [{ "text": "Черт!", "next": "room_hub" }]
        },

        /* 3. Secret Code */
        "code_attempt": {
            "id": "code_attempt",
            "speaker": "INTERFACING",
            "text": "Ты исполняешь ритуальный танец: удар кулаком сверху, удар сбоку, пауза, резкий пинок снизу. Машина замирает... мигает всеми огнями... и дверь открывается.",
            "options": [{ "text": "Знание — сила.", "next": "victory_scene" }]
        },

        /* 4. Exorcism */
        "exo_success": {
            "id": "exo_success",
            "speaker": "INLAND EMPIRE",
            "text": "Ты кладешь руки на машину и поешь гимн Ревашоля. Ты говоришь с Духом Воды. Ты обещаешь ему, что больше никогда не будешь стирать цветное с белым. \n\nМашина верит тебе. Замок щелкает.",
            "options": [{ "text": "Спасибо, дух.", "next": "victory_scene" }]
        },
        "exo_fail": {
            "id": "exo_fail",
            "speaker": "VOLITION",
            "text": "Ты стоишь на коленях перед стиральной машиной и воешь. Случайный прохожий заглядывает в окно, видит это, крестится и убегает. Ты чувствуешь себя невероятно глупо.",
            "effects": [{ "key": "morale", "val": -2 }],
            "options": [{ "text": "Встать с колен.", "next": "room_hub" }]
        },

        /* --- ENDINGS --- */
        "victory_scene": {
            "id": "victory_scene",
            "speaker": "HORRIFIC NECKTIE",
            "text": "Да! ДА! Она свободна! \n\nТы достаешь рубашку. Она горячая, пахнет химической свежестью и победой. Ты надеваешь её прямо поверх майки. Твоя харизма мгновенно возрастает до стратосферы. Даже Кот смотрит на тебя с уважением.",
            "options": [
                { "text": "Выйти в дождь, чувствуя себя королем.", "next": "end_game_win" }
            ]
        },
        "game_over_injury": {
            "id": "game_over_injury",
            "speaker": "END",
            "text": "Боль слишком сильна. Ты теряешь сознание на полу прачечной. Последнее, что ты видишь — как Кот Комиссар доедает твои чипсы.",
            "options": []
        },
        "end_game_win": {
            "id": "end_game_win",
            "speaker": "CREDITS",
            "text": "Поздравляем. Вы прошли мини-квест «Реквием по носку». Ваша рубашка спасет этот город.\n\nСпасибо за игру.",
            "options": []
        }
    }
};

/* =========================================
   2. GAME ENGINE CLASS
   ========================================= */

class DiscoEngine {
    constructor(data, ui) {
        this.nodes = data.nodes;
        this.ui = ui;
        this.state = {
            stats: { health: 3, morale: 3 },
            skills: {
                logic: 4, rhetoric: 2, endurance: 3, 
                physical_instrument: 2, inland_empire: 4, empathy: 1
            },
            flags: {},
            history: []
        };
        this.currentNode = null;
    }

    start() {
        this.ui.updateStats(this.state);
        this.loadNode('start');
    }

    loadNode(nodeId) {
        const node = this.nodes[nodeId];
        if (!node) return;

        this.currentNode = node;
        this.ui.appendHistory(node);
        const validOptions = this.processOptions(node.options);
        this.ui.renderOptions(validOptions, (index) => this.selectOption(index, validOptions));
    }

    processOptions(options) {
        if (!options) return [];
        return options.map((opt, idx) => {
            if (opt.condition && !this.checkCondition(opt.condition)) return null;
            return { ...opt, originalIndex: idx };
        }).filter(Boolean);
    }

    selectOption(index, currentOptions) {
        const choice = currentOptions[index];
        if (!choice) return;
        this.ui.appendPlayerChoice(choice.text);
        if (choice.type === 'check') {
            this.runCheck(choice);
            return;
        }
        this.transition(choice);
    }

    runCheck(choice) {
        const { skill, difficulty, success, failure } = choice.check;
        const skillVal = this.state.skills[skill] || 0;

        this.ui.showDiceRoll(skill, skillVal, difficulty, (passed) => {
            const nextNodeId = passed ? success : failure;
            this.transition({ next: nextNodeId, effects: choice.effects });
        });
    }

    transition(choice) {
        if (choice.effects) {
            choice.effects.forEach(eff => this.applyEffect(eff));
            this.ui.updateStats(this.state);
        }
        if (this.state.stats.health <= 0 || this.state.stats.morale <= 0) {
            this.ui.appendSystemMessage("КРИТИЧЕСКИЙ СБОЙ СИСТЕМЫ. ВЫ УМЕРЛИ.");
            this.ui.clearOptions();
            return;
        }
        if (choice.next) {
            this.loadNode(choice.next);
        } else {
            this.ui.appendSystemMessage("КОНЕЦ.");
            this.ui.clearOptions();
        }
    }

    checkCondition(cond) {
        let val = 0;
        if (cond.type === 'stat') val = this.state.skills[cond.key] || 0;
        switch (cond.op) {
            case '>=': return val >= cond.val;
            case '<': return val < cond.val;
            default: return false;
        }
    }

    applyEffect(effect) {
        if (['health', 'morale'].includes(effect.key)) {
            this.state.stats[effect.key] += effect.val;
            this.ui.showFloatingText(`${effect.key} ${effect.val > 0 ? '+' : ''}${effect.val}`);
        }
    }
}

/* =========================================
   3. UI HANDLER
   ========================================= */

class DiscoUI {
    constructor() {
        this.logContainer = document.getElementById('history-log');
        this.optContainer = document.getElementById('options-area');
        this.diceOverlay = document.getElementById('dice-overlay');
        
        // Mobile Menu Init
        this.sidebar = document.getElementById('sidebar');
        this.sidebarOverlay = document.getElementById('sidebar-overlay');
        this.mobileBtn = document.getElementById('mobile-menu-btn');
        this.closeBtn = document.getElementById('close-menu-btn');

        this.mobileBtn.onclick = () => this.toggleSidebar(true);
        this.closeBtn.onclick = () => this.toggleSidebar(false);
        this.sidebarOverlay.onclick = () => this.toggleSidebar(false);
    }

    toggleSidebar(show) {
        if (show) {
            this.sidebar.classList.add('open');
            this.sidebarOverlay.classList.add('visible');
        } else {
            this.sidebar.classList.remove('open');
            this.sidebarOverlay.classList.remove('visible');
        }
    }

    updateStats(state) {
        const hpCont = document.getElementById('hp-container');
        hpCont.innerHTML = '';
        for(let i=0; i<5; i++) {
            const pip = document.createElement('div');
            pip.className = `hp-pip ${i < state.stats.health ? 'active' : ''}`;
            hpCont.appendChild(pip);
        }

        const mpCont = document.getElementById('mp-container');
        mpCont.innerHTML = '';
        for(let i=0; i<5; i++) {
            const pip = document.createElement('div');
            pip.className = `hp-pip ${i < state.stats.morale ? 'active' : ''}`;
            mpCont.appendChild(pip);
        }

        for (let [key, val] of Object.entries(state.skills)) {
            const el = document.getElementById(`stat-${key}`);
            if (el) el.innerText = val;
        }
    }

    appendHistory(node) {
        const div = document.createElement('div');
        div.className = 'dialogue-entry';
        let speakerClass = 'speaker-SYSTEM';
        if (node.speaker === 'YOU') speakerClass = 'speaker-YOU';
        else if (node.speaker.includes('REPTILIAN')) speakerClass = 'speaker-REPTILIAN';
        else if (node.speaker.includes('LIMBIC')) speakerClass = 'speaker-LIMBIC';
        
        div.innerHTML = `
            <div class="speaker-label ${speakerClass}">${node.speaker}</div>
            <div class="dialogue-text">${node.text}</div>
        `;
        this.logContainer.appendChild(div);
        this.scrollToBottom();
    }

    appendPlayerChoice(text) {
        const div = document.createElement('div');
        div.className = 'dialogue-entry';
        div.style.opacity = "0.7";
        div.innerHTML = `
            <div class="speaker-label speaker-YOU">YOU</div>
            <div class="dialogue-text" style="font-style: italic;">${text}</div>
        `;
        this.logContainer.appendChild(div);
        this.scrollToBottom();
    }

    appendSystemMessage(text) {
        const div = document.createElement('div');
        div.className = 'dialogue-entry';
        div.innerHTML = `<div class="dialogue-text" style="color:red; font-weight:bold;">${text}</div>`;
        this.logContainer.appendChild(div);
        this.scrollToBottom();
    }

    scrollToBottom() {
        this.logContainer.scrollTop = this.logContainer.scrollHeight;
    }

    showFloatingText(text) {
        const div = document.createElement('div');
        div.style.fontSize = '0.8em';
        div.style.color = '#888';
        div.style.textAlign = 'center';
        div.innerText = `[ ${text} ]`;
        this.logContainer.appendChild(div);
    }

    renderOptions(options, callback) {
        this.optContainer.innerHTML = '';
        options.forEach((opt, index) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            let html = opt.text;
            if (opt.type === 'check') {
                let colorClass = 'check-logic';
                if (['endurance', 'physical_instrument'].includes(opt.check.skill)) colorClass = 'check-physique';
                if (['inland_empire', 'empathy'].includes(opt.check.skill)) colorClass = 'check-psyche';
                html = `<span class="check-tag ${colorClass}">${opt.check.skill} [${opt.check.difficulty}]</span> ${opt.text}`;
            }
            btn.innerHTML = html;
            btn.onclick = () => callback(index);
            this.optContainer.appendChild(btn);
        });
    }

    clearOptions() {
        this.optContainer.innerHTML = '';
    }

    showDiceRoll(skill, skillVal, target, onComplete) {
        this.diceOverlay.style.display = 'flex';
        const die1El = document.getElementById('dice-val-1');
        const die2El = document.getElementById('dice-val-2');
        const bonusEl = document.getElementById('dice-bonus');
        const totalEl = document.getElementById('dice-total');
        const statusEl = document.getElementById('dice-status');
        const btn = document.getElementById('dice-continue-btn');
        const targetEl = document.getElementById('dice-target');
        const skillNameEl = document.getElementById('dice-skill-name');

        btn.style.display = 'none';
        statusEl.innerText = "ROLLING...";
        statusEl.className = "check-status";
        statusEl.classList.remove("status-success", "status-fail");
        bonusEl.innerText = skillVal;
        targetEl.innerText = target;
        skillNameEl.innerText = skill;

        let rolls = 0;
        const interval = setInterval(() => {
            const r1 = Math.floor(Math.random() * 6) + 1;
            const r2 = Math.floor(Math.random() * 6) + 1;
            die1El.innerText = r1;
            die2El.innerText = r2;
            totalEl.innerText = r1 + r2 + skillVal;
            rolls++;
            
            if (rolls > 15) {
                clearInterval(interval);
                const finalR1 = Math.floor(Math.random() * 6) + 1;
                const finalR2 = Math.floor(Math.random() * 6) + 1;
                const total = finalR1 + finalR2 + skillVal;
                die1El.innerText = finalR1;
                die2El.innerText = finalR2;
                totalEl.innerText = total;

                const isCritSuccess = (finalR1 === 6 && finalR2 === 6);
                const isCritFail = (finalR1 === 1 && finalR2 === 1);
                let passed = false;
                if (isCritSuccess) passed = true;
                else if (isCritFail) passed = false;
                else passed = total >= target;

                if (passed) {
                    statusEl.innerText = isCritSuccess ? "CRITICAL SUCCESS!" : "SUCCESS";
                    statusEl.classList.add("status-success");
                } else {
                    statusEl.innerText = isCritFail ? "CRITICAL FAILURE!" : "FAILURE";
                    statusEl.classList.add("status-fail");
                }
                btn.style.display = 'block';
                btn.onclick = () => {
                    this.diceOverlay.style.display = 'none';
                    onComplete(passed);
                };
            }
        }, 80);
    }
}

/* =========================================
   4. BOOTSTRAP
   ========================================= */
document.addEventListener("DOMContentLoaded", () => {
    const ui = new DiscoUI();
    const engine = new DiscoEngine(storyData, ui);
    engine.start();
});

</script>
</body>
</html>
