<!DOCTYPE html />
<html>

<head>
<meta charset="utf-8">
<title>G-код генератор – очистка прямоугольной области</title>
<script src="theme-switcher.js"></script>
<style>
/* Специфичные стили для minaz1 */
input {
  width: 150px;
  padding: 10px 12px;
  font-size: 14px;
  margin-left: 10px;
}

textarea {
  width: 100%;
  height: 380px;
  margin-top: 15px;
}

ol, p {
  background: rgba(255,255,255,0.05);
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
  border-left: 4px solid #4fc3f7;
}

@media (max-width: 768px) {
  input {
    width: 120px;
    margin-left: 0;
    margin-top: 5px;
  }
}
</style>
  </head>

<body>
<h1>Генератор G-кода для «минажницы»</h1>

<form id="frm">
  <fieldset>
    <legend>Габариты кармана</legend>
    <label>Ширина X, мм <input type="number" step="0.01" id="w" value="120"></label>
    <label>Высота Y, мм <input type="number" step="0.01" id="h" value="80"></label>
    <label>Глубина Z, мм (положит.) <input type="number" step="0.01" id="depth" value="12"></label>
  </fieldset>

  <fieldset>
    <legend>Фреза</legend>
    <label>Диаметр, мм <input type="number" step="0.01" id="tool" value="6"></label>
    <label>Число зубьев <input type="number" id="flutes" value="2"></label>
    <label>Подача на зуб mm/tooth <input type="number" step="0.001" id="chip" value="0.02"></label>
  </fieldset>

  <fieldset>
    <legend>Подачи</legend>
    <label>Скорость резания XY, мм/мин (0 = авто) <input type="number" id="feedXY" value="0"></label>
    <label>Скорость заглубления Z, мм/мин (0 = авто/½ XY) <input type="number" id="feedZ" value="0"></label>
    <label>Обороты шпинделя, об/мин <input type="number" id="rpm" value="12000"></label>
  </fieldset>

  <fieldset>
    <legend>Стратегия проходов</legend>
    <label>Шаг по глубине (step-down), мм <input type="number" step="0.01" id="stepDown" value="2"></label>
    <label>Перекрытие (% диаметра) <input type="number" id="stepOver" value="40"></label>
    <label>Безопасное Z, мм <input type="number" step="0.1" id="safe" value="5"></label>
    <label>Начальная точка X0, мм <input type="number" step="0.01" id="x0" value="0"></label>
    <label>Начальная точка Y0, мм <input type="number" step="0.01" id="y0" value="0"></label>
  </fieldset>

  <button type="button" id="go">Сгенерировать</button>
  <button type="button" id="save">Скачать *.nc</button>
</form>

<h2>Сгенерированный G-код</h2>
<textarea id="gcode"></textarea>

<div style="margin-top: 20px;">
  <h3>Визуализация G-кода</h3>
  <canvas id="canvas" style="width: 100%; height: 400px; background: rgba(0,0,0,0.2); cursor: grab; display: none; border-radius: 8px;"></canvas>
</div>

<script src="gcode-visualizer.js"></script>
<script>
const $ = id => document.getElementById(id);

let visualizer = null;

$("go").onclick = () => {
  $("gcode").value = buildPocket();
  // Автоматически показать визуализацию после генерации
  const canvas = $("canvas");
  canvas.style.display = "block";
  
  // Небольшая задержка чтобы canvas получил правильные размеры
  setTimeout(() => {
    if (!visualizer) {
      visualizer = new GCodeVisualizer(canvas);
    } else {
      visualizer.refresh(); // Обновляем размеры canvas
    }
    visualizer.loadGCode($("gcode").value);
  }, 10);
};



$("save").onclick = () => {
  const blob = new Blob([$("gcode").value], {type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "pocket.nc";
  a.click();
  URL.revokeObjectURL(a.href);
};

function buildPocket(){
  // Чтение параметров
  const w = +$("w").value,     h = +$("h").value,   dep = +$("depth").value;
  const d = +$("tool").value,  flutes = +$("flutes").value;
  const chip = +$("chip").value, rpm = +$("rpm").value;
  let feedXY = +$("feedXY").value, feedZ = +$("feedZ").value;
  const stepDown = +$("stepDown").value;
  const stepOver = d * (+$("stepOver").value)/100;
  const safe = +$("safe").value;
  const x0 = +$("x0").value,  y0 = +$("y0").value;

  // Автоматический расчёт подач
  if(feedXY<=0){
    feedXY = rpm * flutes * chip;     // F = n * z * fz
  }
  if(feedZ<=0){
    feedZ = feedXY/2;                 // обычно 40-60 % от Fxy
  }

  const lines = [];
  const push = l => lines.push(l);

  push(`(Прямоугольный карман ${w}x${h} глубиной ${dep} мм, фреза Ø${d})`);
  push("(Сгенерировано JS-генератором)");
  push("G21 G90 G17");               // мм, абсолют, плоскость XY
  push(`F${feedXY.toFixed(0)}`);
  push(`G0 Z${safe}`);               // поднимаемся на безопасную
  push(`M3 S${rpm}`);                // запуск шпинделя

  const startX = x0 + d/2;
  const endX   = x0 + w - d/2;
  const startY = y0 + d/2;
  const endY   = y0 + h - d/2;

  const passesZ = Math.ceil(dep/stepDown);
  let currentZ = 0;

  for(let p=1; p<=passesZ; p++){
    currentZ = -Math.min(stepDown*p, dep);     // отрицательная координата!

    push(`(---- Заглубление ${p} : Z${currentZ.toFixed(3)} ----)`);
    push(`G0 X${startX.toFixed(3)} Y${startY.toFixed(3)}`);
    push(`G1 Z${currentZ.toFixed(3)} F${feedZ.toFixed(0)}`);  // врезание

    let y = startY, dir = true;
    while(y <= endY + 0.0001){
      const xDest = dir ? endX : startX;
      push(`G1 X${xDest.toFixed(3)} F${feedXY.toFixed(0)}`);  // проход
      y += stepOver;
      if (y <= endY + 0.0001){
        push(`G1 Y${Math.min(y,endY).toFixed(3)}`);
      }
      dir = !dir;
    }
    push(`G0 Z${safe}`); // выход на безопасную перед следующей глубиной
  }

  push("M5");                     // стоп шпинделя
  push(`G0 X${x0} Y${y0}`);       // возврат в ноль
  push("M30");

  return lines.join("\n");
}
</script>


Как работает стратегия
<ol>
<li>Инструмент позиционируется в начало (диаметр/2 от левой и нижней стенки).  </li>
<li>Заглубление выполняется ступенями «step-down».  </li>
<li>На каждом уровне режем параллельными проходами с перекрытием «step-over» % диаметра, чередуя направление (зиг-заг).  </li>
<li>По окончании уровня поднимаемся в безопасную Z, затем переходим к следующему.  </li>
</ol>
<p>Почему именно так
• Для изготовления мелкой минажницы обычно используется шаровая или цилиндрическая фреза Ø4-8 мм.<br>
• 40 % перекрытия ≈ оптимум между временем обработки и качеством дна.<br>
• Зиг-заг удобен, прост для ЧПУ и почти не оставляет «гребёнки» при шаровой фрезе.<br>
• Подачи можно задать вручную или рассчитает скрипт по классической формуле:<br>
Feed = RPM × flutes × chip-load.  </p>
<p>Что можно улучшить
• Добавить вход по спирали вместо прямого врезания.<br>
• Реализовать «спираль от центра» или «карман по спирали» – иногда даёт лучшее качество.<br>
• Генерировать команды M7/M8 (охлаждение) или смену инструмента.<br>
• Проверять, влазит ли step-over в карман (если too narrow).<br>
• Поддержать дюймовый режим (G20) простым переключателем.</p>

</body>
</html>
