<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Калькулятор фрезерования ЧПУ</title>
<script src="theme-switcher.js"></script>
<style>
/* Специфичные стили для калькулятора */
input, select {
  width: 100%;
}

.btn {
  margin-top: 20px;
  padding: 14px 30px;
  font-size: 18px;
  text-transform: uppercase;
  letter-spacing: 1px;
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: fit-content;
}

h2 {
  font-size: 18px;
}

@media (max-width: 768px) {
  .btn {
    width: 100%;
    margin-left: 0;
    margin-right: 0;
  }
}
</style>
</head>
<body>

<h1>Калькулятор режимов фрезерования</h1>

<!-- 1. Материал и задача --------------------------------->
<section>
  <h2>1. Заготовка</h2>
  <label>Материал</label>
  <select id="mat">
    <option value="softWood">Дерево мягкое (сосна, ель)</option>
    <option value="medWood">Дерево среднее / фанера / MDF</option>
    <option value="hardWood">Дерево твёрдое (дуб, бук)</option>
    <option value="aluWrought">Алюминий (6061/6082)</option>
    <option value="aluCast">Алюминий литой</option>
    <option value="pmma">Оргстекло (PMMA)</option>
  </select>

  <label>Тип операции</label>
  <select id="operation">
    <option value="rough">Черновая (съём объёма)</option>
    <option value="finish">Чистовая (качество поверхности)</option>
  </select>
</section>

<!-- 2. Инструмент --------------------------------------->
<section>
  <h2>2. Инструмент</h2>

  <label>Диаметр фрезы D, мм</label>
  <input id="toolD" type="number" value="6">

  <label>Количество зубьев z</label>
  <input id="flutes" type="number" value="2">

  <label>Вид фрезы</label>
  <select id="toolType">
    <option value="regular">Стандартная 2-зуб. up-cut (по умолчанию)</option>
    <option value="single">1-зуб спиральная</option>
    <option value="multi">3-4 зуба (многозаходная)</option>
    <option value="compression">Compression</option>
    <option value="down">Down-cut</option>
    <option value="ball">Ball-nose (шаровая)</option>
    <option value="vbit">V-бит (гравёрная)</option>
    <option value="corn">Черновая Corn-cob</option>
  </select>

  <label>Материал фрезы</label>
  <select id="toolMat">
    <option value="carbide">Твёрдый сплав / карбид</option>
    <option value="hss">HSS (быстрорежущая сталь)</option>
  </select>
</section>

<!-- 3. Шпиндель ---------------------------------------->
<section>
  <h2>3. Шпиндель</h2>
  <label>Макс. обороты n<sub>max</sub>, об/мин</label>
  <input id="nMax" type="number" value="24000">

  <label>Номинальная мощность P<sub>сп</sub>, кВт</label>
  <input id="pMax" type="number" step="0.1" value="0.8">
</section>

<!-- 4. Глубины резания --------------------------------->
<section>
  <h2>4. Глубины резания (можно оставить пустыми)</h2>
  <label>Осевая глубина ap, мм</label>
  <input id="ap" type="number" placeholder="по умолчанию зависит от фрезы">

  <label>Радиальная глубина ae, мм</label>
  <input id="ae" type="number" placeholder="по умолчанию зависит от фрезы">
</section>

<button class="btn" onclick="calc()">Рассчитать</button>

<!-- 5. Вывод ------------------------------------------->
<section id="result">
  <h2>Результаты</h2>
  <div id="out"></div>
</section>

<script>
/* ---------- Таблицы исходных данных ----------------- */
const tables = {
  Vc: { // м/мин  min,max
    softWood:{rough:[200,280],finish:[250,330]},
    medWood :{rough:[140,220],finish:[200,260]},
    hardWood:{rough:[ 90,160],finish:[130,200]},
    aluWrought:{rough:[180,280],finish:[220,320]},
    aluCast  :{rough:[100,160],finish:[130,200]},
    pmma     :{rough:[140,220],finish:[200,300]}
  },
  fz: [ // мм/зуб (карбид)
    {d:3 , wood:[0.02,0.05], alu:[0.013,0.03], pmma:[0.015,0.035]},
    {d:6 , wood:[0.04,0.10], alu:[0.025,0.06], pmma:[0.03 ,0.07 ]},
    {d:8 , wood:[0.06,0.15], alu:[0.04 ,0.08], pmma:[0.05 ,0.10]},
    {d:10, wood:[0.08,0.20], alu:[0.05 ,0.10], pmma:[0.06 ,0.12]},
    {d:12, wood:[0.10,0.25], alu:[0.06 ,0.12], pmma:[0.08 ,0.14]}
  ],
  kc:{softWood:350,medWood:480,hardWood:550,aluWrought:400,aluCast:500,pmma:350}
};

/* ---------- Правила для разных типов фрез ------------ */
const toolTypes = {
  regular:{fz:1, Vc:1},
  single :{fz:1.25, Vc:1,
           note:"fz увеличена на 25 % для 1-зубовой фрезы."},
  multi  :{fz:0.85, Vc:1,
           note:"fz снижена на 15 % для 3-4-зубовой фрезы."},
  compression:{fz:1, Vc:1, minAp:3,
           note:"Для compression ap должна быть > 3 мм."},
  down   :{fz:1, Vc:0.9,
           note:"Vc и Vf уменьшены на 10 % для down-cut (хуже теплоотвод)."},
  ball   :{fz:1, Vc:1, maxApFactor:0.1,
           note:"ap ограничена 0.1·D для шаровой фрезы."},
  vbit   :{fz:1, Vc:1, fakeD:2,
           note:"Для расчёта принят эквивалентный Ø 2 мм (V-бит)."},
  corn   :{fz:1.2, Vc:1, defaultAeFactor:0.8,
           note:"fz ↑20 %, ae по умолчанию 0.8·D для черновой Corn-cob."}
};

/* ---------- Интерполяция fz по диаметру -------------- */
function interpFz(d, arr){
  for(let i=0;i<arr.length-1;i++){
    if(d<=arr[i+1].d){
      const k=(d-arr[i].d)/(arr[i+1].d-arr[i].d);
      return [
        arr[i].wood[0]*(1-k)+arr[i+1].wood[0]*k,
        arr[i].wood[1]*(1-k)+arr[i+1].wood[1]*k,
        arr[i].alu [0]*(1-k)+arr[i+1].alu [0]*k,
        arr[i].alu [1]*(1-k)+arr[i+1].alu [1]*k,
        arr[i].pmma[0]*(1-k)+arr[i+1].pmma[0]*k,
        arr[i].pmma[1]*(1-k)+arr[i+1].pmma[1]*k
      ];
    }
  }
  return arr[arr.length-1];
}

/* -------------- ГЛАВНАЯ ФУНКЦИЯ ----------------------- */
function calc(){
  /* ---- чтение ввода ---- */
  const mat = document.getElementById("mat").value;
  const op  = document.getElementById("operation").value;
  const Dusr= parseFloat(document.getElementById("toolD").value)||6;
  const z   = parseInt(document.getElementById("flutes").value)||2;
  const tTypeKey = document.getElementById("toolType").value;
  const tAdj = toolTypes[tTypeKey];
  const toolMat = document.getElementById("toolMat").value;
  const nMax= parseInt(document.getElementById("nMax").value)||24000;
  const pMax= parseFloat(document.getElementById("pMax").value)||0.8;
  let  apInp=parseFloat(document.getElementById("ap").value);
  let  aeInp=parseFloat(document.getElementById("ae").value);

  const out = document.getElementById("out");
  let warn = [];
  let expl = [];

  /* ---- учёт «виртуального» диаметра (V-bit) ---- */
  let D = Dusr;
  if(tAdj.fakeD){
    D = tAdj.fakeD;
    expl.push("Для V-бит используется эквивалентный диаметр 2 мм.");
  }

  /* ---- скорость резания ---- */
  let Vc = (tables.Vc[mat][op][0]+tables.Vc[mat][op][1])/2;
  if(toolMat==="hss") Vc*=0.6;
  Vc*=tAdj.Vc;

  /* ---- обороты ---- */
  let n = 1000*Vc/(Math.PI*D);
  if(n>nMax){
    warn.push(`Обороты по расчёту ${n.toFixed(0)} > n<sub>max</sub> (${nMax}). Vc понижена.`);
    n = nMax;
    Vc = n*Math.PI*D/1000;
  }

  /* ---- fz ---- */
  const row = interpFz(D,tables.fz);
  let fzMin,fzMax;
  if(mat.startsWith("alu")) {fzMin=row[2];fzMax=row[3];}
  else if(mat==="pmma"){fzMin=row[4];fzMax=row[5];}
  else {fzMin=row[0];fzMax=row[1];}

  let fz = ((fzMin+fzMax)/2)* (op==="rough"?1.15:0.7);
  if(toolMat==="hss") fz*=0.8;
  fz*=tAdj.fz;  // поправка по типу фрезы

  /* ---- глубины резания ---- */
  let ap = apInp;
  let ae = aeInp;

  // дефолт, если пользователь ничего не ввёл
  if(!ap){
    ap = (op==="rough"?0.5:0.2)*D;
  }
  if(!ae){
    ae = (op==="rough"?0.3:0.1)*D;
  }

  // специальные дефолты и ограничения по типу фрезы
  if(!aeInp && tAdj.defaultAeFactor){ae = tAdj.defaultAeFactor*D;}
  if(tAdj.maxApFactor && ap > tAdj.maxApFactor*D){
    ap = tAdj.maxApFactor*D;
    warn.push(`ap ограничена ${ap.toFixed(2)} мм (шаровая фреза).`);
  }
  if(tAdj.minAp && ap < tAdj.minAp){
    warn.push(`Для compression-фрезы ap должна быть > ${tAdj.minAp} мм.`);
  }

  /* ---- поправка «тонкой стружки» ---- */
  let fzCorr = fz;
  if(ae < 0.5*D){
    fzCorr = fz*(D/2)/ae;
    warn.push("Увеличена подача (тонкая стружка, ae < 0.5·D).");
  }

  /* ---- итоговая подача ---- */
  const Vf = n*z*fzCorr;

  /* ---- силы и мощность ---- */
  const Fc = tables.kc[mat]*ap*ae;
  const P  = Fc*Vc/60000;
  const T  = 9550*P/n;
  if(P>pMax){
    warn.push(`Мощность ${P.toFixed(2)} кВт > P<sub>сп</sub> (${pMax} кВт).`);
  }

  /* ---- пояснения по типу фрезы ---- */
  if(tAdj.note) expl.push(tAdj.note);

  /* ---- ВЫВОД ---- */
  out.innerHTML = `
    <p><b>Обороты n:</b> ${n.toFixed(0)} об/мин</p>
    <p><b>Подача Vf:</b> ${Vf.toFixed(0)} мм/мин
       &nbsp;(<span title="подача на зуб">${fzCorr.toFixed(3)}</span> мм/зуб)</p>
    <p><b>Скорость резания Vc:</b> ${Vc.toFixed(0)} м/мин</p>
    <p><b>Глубины:</b> ap = ${ap.toFixed(2)} мм, ae = ${ae.toFixed(2)} мм</p>
    <p><b>Съём Q:</b> ${(ap*ae*Vf/1000).toFixed(0)} см³/мин</p>
    <p><b>Мощность P:</b> ${P.toFixed(2)} кВт;
       &nbsp;<b>Момент T:</b> ${T.toFixed(2)} Н·м</p>
  `;

  if(expl.length){
    out.innerHTML += `<p><b>Коррекции по типу фрезы:</b><br>• `
                    + expl.join("<br>• ") + `</p>`;
  }
  if(warn.length){
    out.innerHTML += `<p class="warn"><b>⚠ Предупреждения:</b><br>• `
                    + warn.join("<br>• ") + `</p>`;
  }else{
    out.innerHTML += `<p>✅ Ограничения не превышены.</p>`;
  }
}
</script>


<!-- =======================================================
     Полезно новичку (GRBL + CNCjs)
     Добавьте в любое место вашего index.html
========================================================= -->
<section>
  <h2>Помощь новичку</h2>

  <!-- 1. Чек-лист безопасности -->
  <details open>
    <summary><b>1. Чек-лист безопасности перед пуском</b></summary>
    <ul>
      <li>Защитные очки и наушники надеты.</li>
      <li>Ключ и гайки из шпинделя убраны, цанга затянута.</li>
      <li>Заготовка и фреза не касаются друг друга при включении.</li>
      <li>Струбцины/вакуум держат деталь жёстко, кабели не мешают.</li>
      <li>Кнопка аварийного&nbsp;стопа (E-STOP) доступна рукой.</li>
      <li>GRBL пишет «Idle»; ошибок «Alarm/Hard Limit» нет.</li>
      <li>Файл G-кода проверен (симулятор / просмотр траектории).</li>
    </ul>
  </details>

  <!-- 2. Мини-шпаргалка G-кодов -->
  <details>
    <summary><b>2. Мини-шпаргалка G-кодов (только нужное)</b></summary>
    <table style="width:100%;border-collapse:collapse;font-size:14px">
      <tr><th style="border-bottom:1px solid #ccc">Код</th><th style="border-bottom:1px solid #ccc">Назначение</th></tr>
      <tr><td>G0</td><td>Быстрое перемещение (без резания)</td></tr>
      <tr><td>G1</td><td>Рабочая подача (с резанием)</td></tr>
      <tr><td>G2 / G3</td><td>Дуга по часовой / против</td></tr>
      <tr><td>G90 / G91</td><td>Абсолют / инкремент координат</td></tr>
      <tr><td>G54 … G59</td><td>Выбор системы нулей (WCS)</td></tr>
      <tr><td>M3 / M5</td><td>Вкл / выкл шпиндель</td></tr>
      <tr><td>M0 / M1</td><td>Пауза программы</td></tr>
      <tr><td>M30</td><td>Конец программы, сброс</td></tr>
    </table>
  </details>

  <!-- 3. Основные $-параметры GRBL -->
  <details>
    <summary><b>3. Самые нужные параметры GRBL ($)</b></summary>
    <table style="width:100%;border-collapse:collapse;font-size:14px">
      <tr><th style="border-bottom:1px solid #ccc">Парам.</th><th style="border-bottom:1px solid #ccc">Что задаёт</th></tr>
      <tr><td>$100 / $101 / $102</td><td>Шаги на&nbsp;мм по оси&nbsp;X, Y, Z</td></tr>
      <tr><td>$110 / $111 / $112</td><td>Макс. скорость (мм/мин) X&nbsp;Y&nbsp;Z</td></tr>
      <tr><td>$120 / $121 / $122</td><td>Ускорение (мм/с²) X&nbsp;Y&nbsp;Z</td></tr>
      <tr><td>$130 / $131 / $132</td><td>Размер стола (софт-лимиты) X&nbsp;Y&nbsp;Z</td></tr>
    </table>
    <p style="margin-top:6px;font-size:13px">
      Совет: после калибровки шагов/мм используйте команду  
      <code>$$</code> для просмотра, а затем  
      <code>$100=XX.XXXX</code> чтобы задать новое значение.
    </p>
  </details>

  <!-- =======================================================
     4. Виды фрез и особенности применения
  ========================================================= -->
  <details>
    <summary><b>4. Виды фрез и на что они влияют при расчётах</b></summary>

    <table style="width:100%;border-collapse:collapse;font-size:14px;margin-top:8px">
      <tr>
        <th style="border-bottom:1px solid #ccc">Тип фрезы</th>
        <th style="border-bottom:1px solid #ccc">Где применяют</th>
        <th style="border-bottom:1px solid #ccc">Особенности для режимов</th>
      </tr>

      <tr>
        <td><b>Спиральная&nbsp;однозаходная (1&nbsp;зуб)</b></td>
        <td>Алюминий, пластик, фанера. Макс. отвод стружки.</td>
        <td>fz можно брать на&nbsp;20 – 30 % выше, чем для 2-зубовой;  
            ap/ae умеренные (0.3 – 0.6 · D), иначе «поёт».</td>
      </tr>

      <tr>
        <td><b>Спиральная&nbsp;двухзаходная (2&nbsp;зуба)</b></td>
        <td>Универсальная по дереву и пластику.</td>
        <td>Стандартные таблицы расчёта. Хороший баланс скорости и чистоты.</td>
      </tr>

      <tr>
        <td><b>Многозаходная&nbsp;(3-4 зуба)</b></td>
        <td>Чёрновое снятие большого объёма, твёрдая древесина.</td>
        <td>fz снижайте на 15 – 25 %; шпинделю нужно больше момента.<br>
            При недостатке оборотов легко «засверлиться».</td>
      </tr>

      <tr>
        <td><b>Compression<br>(нижний+верхний рез)</b></td>
        <td>Ламинированная фанера, ДСП. Чистый верх/низ кромки.</td>
        <td>Работает корректно, если ap &gt; «зона компрессии» (обычно 3–4 мм).  
            Для неглубоких проходов используйте обычную up-cut.</td>
      </tr>

      <tr>
        <td><b>Up-Cut / Down-Cut</b></td>
        <td>Up-cut: лучший отвод стружки. <br>Down-cut: чистый верх.</td>
        <td>Down-cut греется сильнее → Vc и Vf на 10 – 20 % ниже;  
            не режьте глубокие карманы без продувки — стружка остаётся в канавке.</td>
      </tr>

      <tr>
        <td><b>Ball&nbsp;Nose (шаровая)</b></td>
        <td>3D-чистовая, рельефы.</td>
        <td>Главный параметр — «scallop». При расчёте Ra учитывайте только <i>ae</i> (степ/овер);  
            ap обычно ≤ 0.1 · D. Подход «тонкой стружки» почти всегда активен.</td>
      </tr>

      <tr>
        <td><b>V-бит (гравёрная)</b></td>
        <td>Надписи, фаски 60–90°.</td>
        <td>Диаметр изменяется с глубиной. Для чернового n и Vf возьмите как для Ø 1–2 мм;  
            ap маленькая (0.1 – 1 мм).</td>
      </tr>

      <tr>
        <td><b>Черновая “Corn-Cob”</b></td>
        <td>Быстрое удаление древесины, пенопласт.</td>
        <td>ae можно поднять до 0.8 · D, fz ~ 1.2 × табличного;  
            поверхность очень шероховатая, нужна последующая чистовая.</td>
      </tr>
    </table>

    <p style="margin-top:8px;font-size:13px">
      <b>Коротко:</b> калькулятору “нужны” в первую очередь <i>диаметр</i> и
      <i>количество зубьев</i>. Всё прочее из таблицы выше — это поправки,
      которые можно применять вручную, если требуется:
      уменьшить <i>fz</i> для многозубых, снизить <i>Vc</i> для down-cut,
      ограничить <i>ap/ae</i> для V-бит и шаровых фрез.
    </p>
  </details>
</section>

</body>
</html>
