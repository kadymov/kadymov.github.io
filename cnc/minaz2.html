<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>G-код генератор — карман прямоугольник</title>
<script src="theme-switcher.js"></script>
<style>
/* Специфичные стили для minaz2 */
h2 {
  font-size: 24px;
  text-align: center;
}

.twoCol {
  column-count: 2;
  column-gap: 30px;
}

label {
  display: inline-block;
  width: 220px;
  margin: 8px 0;
  break-inside: avoid;
}

input[type="text"], input[type="number"] {
  width: 100px;
  padding: 8px 10px;
  font-size: 14px;
  margin-left: 8px;
  border-radius: 6px;
}

textarea {
  width: 100%;
  height: 400px;
  margin-top: 10px;
}

button {
  padding: 12px 24px;
  font-size: 16px;
  margin-bottom: 15px;
}

@media (max-width: 768px) {
  .twoCol {
    column-count: 1;
  }
  
  label {
    width: 100%;
    display: block;
    margin-bottom: 5px;
  }
  
  input[type="text"], input[type="number"] {
    width: 100%;
    margin-left: 0;
    margin-top: 5px;
  }
}
</style>
</head>
<body>
<h2>Генератор G-кода для очистки прямоугольной области (спиралью)</h2>

<div class="twoCol">
  <label>Ширина, мм <input id="w"  value="120"></label>
  <label>Высота, мм <input id="h"  value="80"></label>

  <label>Глубина кармана, мм <input id="depth" value="15"></label>
  <label>Шаг по Z (погружение за проход), мм <input id="stepZ" value="2.5"></label>

  <label>Диаметр фрезы, мм <input id="tool" value="6"></label>
  <label>Степ-овер, % (от Ø) <input id="stepover" value="40"></label>

  <label>Безопасная высота Z, мм <input id="safeZ" value="5"></label>
  <label>Стартовая высота Z, мм <input id="startZ" value="1"></label>

  <!-- Часть для ручного ввода подач -->
  <label>Подача XY, мм/мин <input id="feedXY" value="800"></label>
  <label>Подача Z, мм/мин&nbsp;<input id="feedZ"  value="250"></label>

  <!-- Блок «рассчитать автоматически» -->
  <label>RPM шпинделя <input id="rpm" value="16000"></label>
  <label>Число зубьев (флют) <input id="flutes" value="2"></label>
  <label>Chip-load, мм/зуб <input id="chip" value="0.02"></label>
  <label>
    <input type="checkbox" id="autoFeed"> Рассчитать подачи автоматически
  </label>

  <label>Имя программы (комментарий) <input id="comment" value="RectPocket"></label>
</div>

<p><button onclick="generate()">Сгенерировать G-код</button></p>
<textarea id="out" spellcheck="false"></textarea>

<div style="margin-top: 20px;">
  <h3>Визуализация G-кода</h3>
  <canvas id="canvas" style="width: 100%; height: 400px; background: rgba(0,0,0,0.2); cursor: grab; display: none; border-radius: 8px;"></canvas>
</div>

<script src="gcode-visualizer.js"></script>
<script>
let visualizer = null;



function fmt(x){ return (+x).toFixed(3).replace(/\.?0+$/,''); } //Короткий формат

function generate(){
  // 1. Читаем параметры
  const w       = +document.getElementById('w').value;
  const h       = +document.getElementById('h').value;
  const depth   = +document.getElementById('depth').value;
  const stepZ   = +document.getElementById('stepZ').value;
  const toolD   = +document.getElementById('tool').value;
  const stepoverPct = +document.getElementById('stepover').value/100.0;
  const safeZ   = +document.getElementById('safeZ').value;
  const startZ  = +document.getElementById('startZ').value;

  let feedXY = +document.getElementById('feedXY').value;
  let feedZ  = +document.getElementById('feedZ').value;

  // 2. Автоматический расчёт подач (если включено)
  if(document.getElementById('autoFeed').checked){
      const flutes  = +document.getElementById('flutes').value;
      const chip    = +document.getElementById('chip').value;
      const rpm     = +document.getElementById('rpm').value;
      feedXY = rpm * chip * flutes;
      feedZ  = feedXY/3;                       // грубое правило
      // запишем обратно, чтобы пользователь видел
      document.getElementById('feedXY').value = Math.round(feedXY);
      document.getElementById('feedZ' ).value = Math.round(feedZ );
  }

  // 3. Служебные величины
  const stepOver = toolD * stepoverPct;
  const maxOffsetX = w/2 - toolD/2;
  const maxOffsetY = h/2 - toolD/2;

  // 4. Подготовка контейнера под g-код
  const g = [];
  const comment = document.getElementById('comment').value || 'Pocket';

  // --- Преамбула ----------------------------------------------------------
  g.push(`(Программа: ${comment})`);
  g.push('(Сгенерировано в браузере)');
  g.push('G21         (мм)');
  g.push('G90         (абсолютные координаты)');
  g.push('G94         (мм/мин)');
  g.push(`G0  Z${fmt(safeZ)}`);
  g.push('G0  X0 Y0');              // центр кармана
  g.push(`M3  S${document.getElementById('rpm').value}`); // шпиндель
  g.push('');

  //-----------------------------------------------------------------------
  // 5. Проходы по Z
  let currentZ = -stepZ;
  while (currentZ > -depth - 1e-6){
      if(currentZ < -depth) currentZ = -depth;   // последняя ступенька
      g.push(`(---- Погружение Z${fmt(currentZ)} ----)`);
      // Плавное погружение в центре
      g.push(`G1 Z${fmt(currentZ)} F${fmt(feedZ)}`);

      // ------ Спираль по XY ---------------------------------------------
      addRectSpiralPath(g, currentZ, maxOffsetX, maxOffsetY, stepOver, feedXY);

      // Подъём к безопасной высоте
      g.push(`G0 Z${fmt(safeZ)}`);
      currentZ -= stepZ;
  }

  // --- Завершение --------------------------------------------------------
  g.push('M5');
  g.push('G0 Z'+fmt(safeZ));
  g.push('G0 X0 Y0');
  g.push('M30');

  document.getElementById('out').value = g.join('\n');
  
  // Автоматически показать визуализацию после генерации
  const canvas = document.getElementById('canvas');
  canvas.style.display = 'block';
  
  // Небольшая задержка чтобы canvas получил правильные размеры
  setTimeout(() => {
    if (!visualizer) {
      visualizer = new GCodeVisualizer(canvas);
    } else {
      visualizer.refresh(); // Обновляем размеры canvas
    }
    visualizer.loadGCode(document.getElementById('out').value);
  }, 10);
}

// Функция «прямоугольная спираль»,
// начиная с центра (0,0) и постепенно расширяясь к краям.
  /*
function addRectSpiralPath(g, z, maxX, maxY, step, feed){
    // Переходим к правой стороне первой “половинки шага” —
    // это даёт плавную спираль без резких рывков.
    let x=0, y=0;
    g.push(`G1 X${fmt(Math.min(step/2, maxX))} Y0 F${fmt(feed)}`);
    x = Math.min(step/2, maxX);

    // Теперь увеличиваем прямоугольник пока не дойдём до границ
    let offX = step/2, offY = 0;
    while(true){
        // координаты текущей «рамки»
        const left   = -offX;
        const right  =  offX;
        const top    =  offY;
        const bottom = -offY;

        // Проверка выхода за пределы
        if(right >  maxX+1e-3 || top >  maxY+1e-3) break;

        // 1) Вниз
        g.push(`G1 X${fmt(right)} Y${fmt(bottom)} F${fmt(feed)}`);
        // 2) Влево
        g.push(`G1 X${fmt(left)}  Y${fmt(bottom)} F${fmt(feed)}`);
        // 3) Вверх
        g.push(`G1 X${fmt(left)}  Y${fmt(top)}    F${fmt(feed)}`);
        // 4) Вправо
        g.push(`G1 X${fmt(right)} Y${fmt(top)}    F${fmt(feed)}`);

        // Расширяем рамку
        offX += step;
        offY += step;
    }
}
*/
// Прямоугольная спираль с ортогональными сегментами
function addRectSpiralPath(g, z, maxX, maxY, step, feed){
    // стартуем в центре
    let right =  step/2;   // первая половинка шага
    let left  = -right;
    let top   = 0;
    let bottom= 0;

    // выходим к первой точке (центр-право)
    g.push(`G1 X${fmt(right)} Y0 F${fmt(feed)}`);

    while (right <= maxX + 1e-6 && top <= maxY + 1e-6){

        // 1. вниз по правой стороне
        g.push(`G1 Y${fmt(bottom - step)} F${fmt(feed)}`);
        bottom -= step;

        // 2. вправо/влево до нового X (если X изменился)
        g.push(`G1 X${fmt(right)} F${fmt(feed)}`);

        // 3. влево по нижней стороне
        g.push(`G1 X${fmt(left - step)} F${fmt(feed)}`);
        left -= step;

        // 4. вверх по левой стороне
        g.push(`G1 Y${fmt(top + step)} F${fmt(feed)}`);
        top += step;

        // 5. вправо по верхней стороне
        g.push(`G1 X${fmt(right + step)} F${fmt(feed)}`);
        right += step;
    }
}
</script>
</body>
</html>
